@let breadcrumbs = items.changes | async;
@if (items.length <= 2 || max === null || max === items.length) {
    @for (item of items; track item; let last = $last) {
        <ng-container [ngTemplateOutlet]="item.templateRef" />
        @if (!last) {
            <ng-container [ngTemplateOutlet]="separatorTemplate" />
        }
    }
}

@if (items.length > 2 && max !== null && max !== items.length) {
    @let visibleItemsCount = max - 2;

    <ng-container *ngTemplateOutlet="items.first.templateRef" />
    <ng-container *ngTemplateOutlet="separatorTemplate" />
    <button
        kbq-button
        rdxRovingFocusItem
        class="kbq-breadcrumb__more"
        [color]="KbqComponentColors.Contrast"
        [kbqDropdownTriggerFor]="hiddenBreadcrumbs"
        [kbqStyle]="KbqButtonStyles.Transparent"
        [openByArrowDown]="false"
    >
        <i kbq-icon="kbq-ellipsis-horizontal_16" [color]="KbqComponentColors.ContrastFade"></i>
    </button>
    <kbq-dropdown #hiddenBreadcrumbs="kbqDropdown">
        @for (item of items.toArray().slice(1, -1 * visibleItemsCount); track item; let last = $last) {
            <ng-container *ngTemplateOutlet="item.templateRef" />
        }
    </kbq-dropdown>
    <ng-container [ngTemplateOutlet]="separatorTemplate" />

    @defer (on immediate) {
        @for (item of items.toArray().slice(-1 * visibleItemsCount); track item; let last = $last) {
            <ng-container *ngTemplateOutlet="item.templateRef" />
            @if (!last) {
                <ng-container [ngTemplateOutlet]="separatorTemplate" />
            }
        }
    }
}

<ng-template #separatorTemplate>
    @if (separator) {
        <ng-container [ngTemplateOutlet]="separator" />
    } @else {
        <i kbq-icon="" class="kbq-breadcrumb__separator" [color]="KbqComponentColors.ContrastFade">&nbsp;/&nbsp;</i>
    }
</ng-template>
