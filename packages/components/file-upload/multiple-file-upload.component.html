<div
    kbqFileDrop
    class="kbq-file-upload"
    [class.kbq-disabled]="disabled"
    [class.kbq-error]="invalid"
    [class.kbq-selected]="files.length"
    [class.kbq-file-upload_default]="size === 'default'"
    [class.kbq-file-upload_compact]="size === 'compact'"
    (filesDropped)="onFileDropped($event)"
>
    @let localeData = resolvedLocaleConfig();
    @if (!files.length) {
        <div class="kbq-file-dropzone">
            @if (size === 'default') {
                <i kbq-icon="kbq-cloud-arrow-up-o_32" class="kbq-file-dropzone__icon"></i>
                <div class="kbq-file-dropzone__text">
                    <div class="kbq-file-multiple__header">{{ localeData.title }}</div>
                    <div>
                        <ng-container *ngTemplateOutlet="captionText; context: captionContext()" />
                    </div>
                </div>
            } @else {
                <i kbq-icon="kbq-cloud-arrow-up-o_24" class="kbq-file-dropzone__icon"></i>
                <span class="kbq-file-dropzone__text kbq-file-multiple__caption">
                    <ng-container *ngTemplateOutlet="captionText; context: captionContext()" />
                </span>
            }
        </div>
    } @else {
        <div class="kbq-file-upload__dropzone">
            <div class="kbq-file-upload__grid">
                <div class="kbq-file-multiple-uploaded__header">
                    <div class="kbq-file-multiple-uploaded__header-inner">
                        <div #fileSizeHeaderCell class="kbq-file-upload__file kbq-file-upload__grid-cell">
                            {{ localeData.gridHeaders.file }}
                        </div>
                        <div class="kbq-file-upload__size kbq-file-upload__grid-cell">
                            {{ localeData.gridHeaders.size }}
                        </div>
                        <div class="kbq-file-upload__action kbq-file-upload__grid-cell"></div>
                    </div>
                </div>
                <kbq-list-selection [autoSelect]="false" [disabled]="disabled">
                    @for (file of files; track file) {
                        <kbq-list-option
                            class="kbq-file-multiple__uploaded-item"
                            [value]="file.file.name"
                            (keydown.backspace)="deleteFile($index)"
                            (keydown.delete)="deleteFile($index)"
                        >
                            <div class="kbq-file-upload__row" [class.kbq-error]="file.hasError">
                                <div
                                    class="kbq-file-upload__file kbq-file-upload__grid-cell"
                                    [style.max-width.px]="fileSizeCellMaxWidth"
                                >
                                    @if (
                                        { loading: file.loading | async, progress: file.progress | async };
                                        as asyncData
                                    ) {
                                        @if (!asyncData.loading) {
                                            <ng-container
                                                [ngTemplateOutlet]="$any(customFileIcon)"
                                                [ngTemplateOutletContext]="{ $implicit: file }"
                                            />
                                        }
                                        @if (asyncData.loading) {
                                            <kbq-progress-spinner
                                                class="kbq-file-upload-name-cell__icon"
                                                [mode]="progressMode"
                                                [value]="asyncData.progress || 0"
                                            />
                                        }
                                    }
                                    <span
                                        class="kbq-file-item__text"
                                        [debounceInterval]="0"
                                        [kbqEllipsisCenter]="file.file.name"
                                    ></span>
                                </div>
                                <div class="kbq-file-upload__size kbq-file-upload__grid-cell">
                                    {{ file.file.size | kbqDataSize }}
                                </div>
                                <div
                                    class="kbq-file-upload__action kbq-file-upload__grid-cell"
                                    (click)="deleteFile($index, $event, 'program')"
                                >
                                    <i kbq-icon-button="kbq-circle-xmark_16" tabindex="-1" [disabled]="disabled"></i>
                                </div>
                            </div>
                        </kbq-list-option>
                    }
                </kbq-list-selection>
            </div>
            <div class="kbq-file-btn-upload">
                <div class="kbq-file-dropzone">
                    <i kbq-icon="kbq-cloud-arrow-up-o_24" class="kbq-file-dropzone__icon"></i>
                    <span class="kbq-file-dropzone__text kbq-file-multiple__caption">
                        <ng-container *ngTemplateOutlet="captionText; context: captionContext()" />
                    </span>
                </div>
            </div>
        </div>
    }
</div>

@if (hasHint) {
    <div class="kbq-file-upload__hint">
        <ng-content select="kbq-hint" />
    </div>
}

<ng-template
    #captionText
    let-captionText="captionText"
    let-browseLink="browseLink"
    let-captionTextSeparator="captionTextSeparator"
    let-browseLinkFolder="browseLinkFolder"
>
    @if (captionText) {
        {{ captionText }}
    }
    @if (browseLink) {
        <label
            kbq-link
            pseudo
            kbqFileLoader
            [onlyDirectory]="null"
            [accept]="acceptedFiles"
            [disabled]="disabled"
            [for]="fileUploadContext.id() || inputId"
            [tabIndex]="-1"
            [multiple]="true"
            (fileChange)="onFileSelectedViaClick($event)"
        >
            {{ browseLink }}
        </label>
    }
    @if (captionTextSeparator) {
        {{ captionTextSeparator }}
    }
    @if (browseLinkFolder) {
        <label
            kbq-link
            pseudo
            kbqFileLoader
            [onlyDirectory]="true"
            [disabled]="disabled"
            [tabIndex]="-1"
            (fileChange)="onFileSelectedViaClick($event)"
        >
            {{ browseLinkFolder }}
        </label>
    }
</ng-template>
