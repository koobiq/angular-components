<div
    kbqFileDrop
    class="kbq-file-upload"
    [class.kbq-disabled]="disabled"
    [class.kbq-error]="invalid"
    [class.kbq-selected]="files.length"
    [class.kbq-file-upload_default]="size === 'default'"
    [class.kbq-file-upload_compact]="size === 'compact'"
    [disabled]="fullScreenDropZone()"
    (filesDropped)="onFileDropped($event)"
>
    @let localeData = resolvedLocaleConfig();
    @if (!files.length) {
        @if (size === 'default') {
            <kbq-file-upload-empty-state [size]="'normal'" [title]="localeData.title" [caption]="captionText" />
        } @else {
            <div class="kbq-file-dropzone">
                <i kbq-icon="kbq-arrow-up-from-bracket_16" class="kbq-file-upload__dropzone-icon"></i>
                <span class="kbq-file-upload__dropzone-caption">
                    <ng-container *ngTemplateOutlet="captionText" />
                </span>
            </div>
        }
    } @else {
        <div class="kbq-file-upload__wrapper">
            <kbq-list class="kbq-file-upload__list kbq-scrollbar" role="list">
                @for (file of files; track file) {
                    <kbq-list-item
                        role="listitem"
                        class="kbq-file-upload__item"
                        [class.kbq-disabled]="disabled"
                        (keydown.backspace)="deleteFile($index)"
                        (keydown.delete)="deleteFile($index)"
                    >
                        <div class="kbq-file-upload__row" [class.kbq-error]="file.hasError">
                            <div class="kbq-file-upload__file kbq-file-upload__grid-cell">
                                @if ({ loading: file.loading | async, progress: file.progress | async }; as asyncData) {
                                    @if (!asyncData.loading) {
                                        <ng-container
                                            [ngTemplateOutlet]="$any(customFileIcon)"
                                            [ngTemplateOutletContext]="{ $implicit: file }"
                                        />
                                    }
                                    @if (asyncData.loading) {
                                        <kbq-progress-spinner
                                            class="kbq-file-upload-name-cell__icon"
                                            [mode]="progressMode"
                                            [value]="asyncData.progress || 0"
                                        />
                                    }
                                }
                                <span
                                    class="kbq-file-item__text"
                                    [debounceInterval]="0"
                                    [kbqTooltipDisabled]="disabled"
                                    [kbqEllipsisCenter]="file.file.name"
                                ></span>
                            </div>
                            <div class="kbq-file-upload__size kbq-file-upload__grid-cell">
                                {{ file.file.size | kbqDataSize }}
                            </div>
                            <i
                                kbq-icon-button="kbq-circle-xmark_16"
                                class="kbq-file-upload__action kbq-file-upload__grid-cell"
                                [color]="file.hasError ? 'error' : 'contrast-fade'"
                                [disabled]="disabled"
                                (click)="deleteFile($index, $event, 'program')"
                            ></i>
                        </div>
                    </kbq-list-item>
                }
            </kbq-list>
            <div class="kbq-file-upload__list-footer kbq-file-dropzone">
                <i kbq-icon="kbq-arrow-up-from-bracket_16" class="kbq-file-upload__dropzone-icon"></i>
                <span class="kbq-file-upload__dropzone-caption">
                    <ng-container *ngTemplateOutlet="captionText" />
                </span>
            </div>
        </div>
    }
</div>

@if (hasHint) {
    <div class="kbq-file-upload__hint">
        <ng-content select="kbq-hint" />
    </div>
}

<ng-template #captionText>
    @let context = captionContext();
    @if (files.length) {
        {{ captionTextWhenSelected }}
    } @else if (context.captionText) {
        {{ context.captionText }}
    }
    @if (context.browseLink) {
        <label
            kbq-link
            pseudo
            kbqFileLoader
            [onlyDirectory]="null"
            [accept]="acceptedFiles"
            [disabled]="disabled"
            [for]="fileUploadContext.id() || inputId"
            [tabIndex]="-1"
            [multiple]="true"
            (fileChange)="onFileSelectedViaClick($event)"
        >
            {{ context.browseLink }}
        </label>
    }
    @if (context.captionTextSeparator) {
        {{ context.captionTextSeparator }}
    }
    @if (context.browseLinkFolder) {
        <label
            kbq-link
            pseudo
            kbqFileLoader
            [onlyDirectory]="true"
            [disabled]="disabled"
            [tabIndex]="-1"
            (fileChange)="onFileSelectedViaClick($event)"
        >
            {{ context.browseLinkFolder }}
        </label>
    }
</ng-template>
