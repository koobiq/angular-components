<button
    kbq-button
    kbq-filter-bar-button
    [color]="colors.ContrastFade"
    [kbqDropdownTriggerFor]="savedFilters"
    [kbqStyle]="styles.Outline"
    (dropdownOpened)="input.focus()"
>
    @if (activeFilter?.name) {
        {{ activeFilter!.name }}
    } @else {
        <ng-content>
            <i kbq-icon="kbq-list_16"></i>
            Фильтры
        </ng-content>
    }
</button>

@if (activeFilter?.changed && !activeFilter?.saved) {
    <button
        kbq-button
        kbq-filter-bar-button
        kbqTooltip="Сохранить новый фильтр"
        [color]="colors.Empty"
        (click)="onSaveAsNew.next(this.activeFilter!)"
    >
        <i kbq-icon="kbq-floppy-disk_16"></i>
    </button>
}

@if (activeFilter?.saved) {
    <button
        kbq-button
        kbq-filter-bar-button
        [color]="colors.Empty"
        [kbqDropdownTriggerFor]="filterActions"
        [ngClass]="{ 'kbq-button_changed-saved-filter': savedFilterChanged }"
    >
        <i kbq-icon="kbq-ellipsis-vertical_16"></i>
    </button>
}

@if (activeFilter?.saved) {
    <i kbq-icon="kbq-chevron-right-s_16" class="kbq-filter-bar__arrow" [color]="'theme'"></i>
} @else {
    <kbq-divider class="kbq-filter-bar__separator" [vertical]="true" />
}

<kbq-dropdown #savedFilters="kbqDropdown">
    <kbq-form-field kbqFormFieldWithoutBorders>
        <i kbq-icon="kbq-magnifying-glass_16" kbqPrefix></i>

        <input
            #input
            autocomplete="off"
            kbqInput
            placeholder="Поиск"
            [formControl]="searchControl"
            (click)="stopEventPropagation($event)"
            (keydown)="stopEventPropagation($event)"
        />
        <kbq-cleaner />
    </kbq-form-field>

    <kbq-divider />

    @for (filter of filteredOptions | async; track filter) {
        <button kbq-dropdown-item (click)="selectFilter(filter)">{{ filter.name }}</button>
    } @empty {
        <button kbq-dropdown-item [disabled]="true">Ничего не найдено</button>
    }

    <kbq-divider />

    <button kbq-dropdown-item [disabled]="!activeFilter?.changed" (click)="onSaveAsNew.next(this.activeFilter!)">
        <i kbq-icon="kbq-plus-s_16"></i>
        Сохранить как новый фильтр
    </button>
</kbq-dropdown>

<kbq-dropdown #filterActions="kbqDropdown">
    <button kbq-dropdown-item [ngClass]="{ 'kbq-button_changed-saved-filter': savedFilterChanged }" (click)="save()">
        <i kbq-icon="kbq-floppy-disk_16"></i>
        Сохранить изменения
        @if (savedFilterChanged) {
            <i class="kbq kbq-icon kbq-icon-button kbq-xmark-circle-s_16 kbq-warning layout-margin-left-m"></i>
        }
    </button>
    <button kbq-dropdown-item (click)="onSaveAsNew.next(this.activeFilter!)">
        <i kbq-icon="kbq-plus-s_16"></i>
        Сохранить как новый
    </button>
    <button kbq-dropdown-item (click)="onChangeFilter.next(this.activeFilter!)">
        <i kbq-icon="kbq-pencil_16"></i>
        Изменить
    </button>

    <kbq-divider />

    <button kbq-dropdown-item (click)="onResetFilter.next(this.activeFilter!)">
        <i kbq-icon="kbq-xmark-circle_16"></i>
        Сбросить изменения
    </button>
    <button kbq-dropdown-item (click)="onDeleteFilter.next(this.activeFilter!)">
        <i kbq-icon="kbq-trash_16"></i>
        Удалить
    </button>
</kbq-dropdown>
