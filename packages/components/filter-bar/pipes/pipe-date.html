<button
    #popover="kbqPopover"
    kbq-button
    kbqPopover
    [disabled]="data.disabled"
    [kbq-pipe-state]="data"
    [kbqPopoverArrow]="false"
    [kbqPopoverClass]="'kbq-pipe-date__popover'"
    [kbqPopoverContent]="content"
    [kbqPopoverOffset]="0"
    [kbqPopoverPlacement]="placements.BottomLeft"
    (kbqPopoverVisibleChange)="list = true"
>
    <span class="kbq-pipe__name">{{ data.name }}</span>
    <span class="kbq-pipe__value">{{ formattedValue }}</span>
</button>

@if (showRemoveButton) {
    <kbq-pipe-button />
}

<ng-template #content>
    @if (list) {
        <div class="kbq-date-list">
            <kbq-list-selection #listSelection>
                <kbq-list-option (click)="openPeriod()" (keydown.enter)="openPeriod()">
                    Произвольный период
                    <i class="kbq kbq-icon kbq-chevron-right_16 kbq-contrast-fade"></i>
                </kbq-list-option>

                @for (item of values; track item) {
                    <kbq-list-option [value]="item" (click)="onSelect(item)" (keydown.enter)="onSelect(item)">
                        {{ item.name }}
                    </kbq-list-option>
                }
            </kbq-list-selection>
        </div>
    } @else {
        <div class="kbq-date-period kbq-datepicker__content" (keydown)="onKeydown($event)">
            <div class="kbq-date-period__header">
                <button
                    #returnButton
                    kbq-button
                    [color]="colors.Theme"
                    [kbqStyle]="styles.Transparent"
                    (click)="openList()"
                    (keydown.enter)="openList()"
                >
                    <i kbq-icon="kbq-chevron-left_16"></i>
                    Назад к выбору периода
                </button>
            </div>

            <kbq-divider />

            <form class="kbq-date-period__content kbq-form-horizontal" [formGroup]="formGroup">
                <div class="kbq-date-period__content-header">Произвольный период</div>
                <div class="kbq-form__row" [class.kbq-form__row_with-time]="showTimepicker">
                    <label class="kbq-form__label flex-10">c</label>

                    <kbq-form-field #startDateField class="kbq-date-period__date kbq-form__control">
                        <input
                            formControlName="start"
                            [kbqCalendar]="startDateCalendar"
                            [max]="formGroup.controls.end.value"
                        />
                        <i kbq-icon="kbq-calendar-o_16" kbqSuffix></i>
                    </kbq-form-field>

                    @if (showTimepicker) {
                        <kbq-form-field class="kbq-date-period__time kbq-form__control">
                            <i kbq-icon="kbq-clock_16" kbqPrefix></i>
                            <input formControlName="start" kbqTimepicker />
                        </kbq-form-field>
                    }
                </div>

                <kbq-calendar #startDateCalendar [class.kbq-calendar_hidden]="!startDateField.hasFocus" />

                <div class="kbq-form__row" [class.kbq-form__row_with-time]="showTimepicker">
                    <label class="kbq-form__label flex-10">по</label>

                    <kbq-form-field #endDateField class="kbq-date-period__date kbq-form__control">
                        <input formControlName="end" [kbqCalendar]="endDateCalendar" />
                        <i kbq-icon="kbq-calendar-o_16" kbqSuffix></i>
                        <kbq-datepicker #datepicker />
                    </kbq-form-field>

                    @if (showTimepicker) {
                        <kbq-form-field class="kbq-date-period__time kbq-form__control">
                            <i kbq-icon="kbq-clock_16" kbqPrefix></i>
                            <input formControlName="end" kbqTimepicker />
                        </kbq-form-field>
                    }
                </div>

                @if (formGroup.controls.start.invalid) {
                    <kbq-hint class="kbq-date-period__hint" [color]="'error'">
                        Начало периода не может быть позже окончания
                    </kbq-hint>
                }

                <kbq-calendar #endDateCalendar [class.kbq-calendar_hidden]="!endDateField.hasFocus" />
            </form>

            <div class="kbq-date-period__footer">
                <button
                    kbq-button
                    [color]="'theme'"
                    [disabled]="disabled"
                    [kbqStyle]="'transparent'"
                    (click)="onApply()"
                    (keydown.enter)="onApply()"
                >
                    <span>Применить</span>
                    &nbsp;
                    <span class="kbq-button_hot-key">Ctrl + Enter</span>
                </button>
            </div>
        </div>
    }
</ng-template>
