@if (trigger.search) {
    <div class="kbq-app-switcher__search-container" (mouseenter)="otherSites.close()">
        <kbq-form-field noBorders>
            <i kbq-icon="kbq-magnifying-glass_16" kbqPrefix></i>
            <input
                autocomplete="off"
                kbqInput
                placeholder="Поиск"
                [ngModel]="searchValue"
                (ngModelChange)="onSearchChange($event)"
                (keydown.escape)="onEscape()"
            />
            <kbq-cleaner />
        </kbq-form-field>
    </div>

    <kbq-divider />
}

<div kbq-scrollbar>
    @if (!searchValue) {
        <div class="kbq-app-switcher__app-container" (mouseenter)="otherSites.close()">
            <div class="kbq-app-switcher-group-header">
                <div class="kbq-app-switcher-group-header__text">{{ trigger.selectedSite?.name }}</div>
                @if (trigger.selectedSite?.status) {
                    <kbq-badge class="kbq-app-switcher-group-header__badge" [compact]="true">
                        {{ trigger.selectedSite.status }}
                    </kbq-badge>
                }
            </div>

            <kbq-dropdown [class]="'kbq-app-switcher-sites'">
                <div kbqDropdownStaticContent class="kbq-app-switcher-site">
                    @for (app of trigger.selectedSite?.apps; track app) {
                        <a
                            #appSwitcherApp="kbqAppSwitcherApp"
                            href=""
                            kbq-app-switcher-app
                            [app]="app"
                            [toggle]="!!app.apps"
                        ></a>

                        @if (!appSwitcherApp.collapsed) {
                            @for (alias of app.apps; track alias) {
                                <a href="" class="kbq-app-switcher-site_nested" kbq-app-switcher-app [app]="alias"></a>
                            }
                        }
                    }
                </div>
            </kbq-dropdown>
        </div>

        @if (withSites) {
            <kbq-divider />

            <div class="kbq-app-switcher__sites-container">
                <div class="kbq-app-switcher-group-header">
                    <div class="kbq-app-switcher-group-header__text">Другие площадки</div>
                </div>

                <kbq-dropdown #otherSites="kbqDropdown">
                    <div kbqDropdownStaticContent class="kbq-app-switcher-sites">
                        @for (site of trigger.sites; track site) {
                            @if (site.id !== trigger.selectedSite?.id) {
                                <div
                                    [kbq-app-switcher-dropdown-site]="site"
                                    [kbqDropdownTriggerFor]="dropdownWithSelectedSite"
                                    [offsetX]="0"
                                    (mouseenter)="activeSite = site"
                                ></div>
                            }
                        }
                    </div>
                </kbq-dropdown>
            </div>

            <kbq-dropdown #dropdownWithSelectedSite="kbqDropdown" [class]="'kbq-app-switcher-sites'">
                @for (app of activeSite?.apps; track app) {
                    @if (app.apps) {
                        <!--                            href=""-->
                        <div
                            #dropdownWithGroupedAppsTrigger="kbqDropdownTrigger"
                            [kbq-app-switcher-dropdown-app]="app"
                            [kbqDropdownTriggerFor]="dropdownWithGroupedApps"
                            [offsetX]="0"
                            [class.kbq-pressed]="dropdownWithGroupedAppsTrigger.opened"
                            (mouseenter)="activeApp = app"
                            (click)="selectAppInSite(activeSite, app)"
                        ></div>
                    } @else {
                        <div [kbq-app-switcher-dropdown-app]="app" (click)="selectAppInSite(activeSite, app)"></div>
                    }
                }
            </kbq-dropdown>

            <kbq-dropdown #dropdownWithGroupedApps="kbqDropdown" [class]="'kbq-app-switcher-sites'">
                @for (app of activeApp?.apps; track app) {
                    <div [kbq-app-switcher-dropdown-app]="app" (click)="selectAppInSite(activeSite, app)"></div>
                }
            </kbq-dropdown>
        }
    } @else {
        <div kbq-scrollbar class="kbq-app-switcher__search-result">
            <kbq-dropdown [class]="'kbq-app-switcher-sites'">
                <div kbqDropdownStaticContent class="kbq-app-switcher-site">
                    @for (site of trigger.sites; track site) {
                        <kbq-optgroup label="{{ site.name }}" />

                        @for (app of site.apps; track app) {
                            <a href="" kbq-app-switcher-app [app]="app"></a>
                        }
                    }
                </div>
            </kbq-dropdown>
        </div>
    }
</div>
