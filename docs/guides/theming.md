В этом руководстве дается подробное описание подключения и настройки тем в Angular приложениях с использованием дизайн-системы Koobiq. В нем рассказывается о подключении готовых тем, кастомизации стандартных тем с помощью дизайн-токенов и расширенной кастомизации с использованием кастомных токенов и переменных CSS.

Термины:
- [Миксины](https://sass-lang.com/documentation/at-rules/mixin/) - повторяющиеся участки кода в Sass.

### Простое подключение темы
Для быстрого запуска вы можете подключить готовую тему из Koobiq. Данный подход позволит использовать стили по-умолчанию для компонентов дизайн системы Koobiq, а также использовать одну из стандартных тем - светлую или темную.

#### Подготовка
Установите пакет дизайн системы Koobiq. Подробнее про установку [тут](./installation.md).

#### Применение темы

1. Импорт готовой темы: включите нужную тему из пакета @koobiq/components/prebuilt-themes, используя команду @use, в свой основной файл стиля. Возможные темы:

| Название файла  | описание                 |
|-----------------|--------------------------|
| light-theme.css | стандартная светлая тема |
| dark-theme.css  | стандартная темная тема  |


#### Пример на Stackblitz
Пример простого подключения можно найти [тут](https://stackblitz.com/edit/vaffk1?file=src%2Fstyles.scss)

### Кастомизация: Уровень 1
В рамках данного раздела дается описание по настройке переключения тем и кастомизации новых компонентов с помощью имеющихся токенов в дизайн системе. Koobiq позволяет подключать стандартные темы оформления (светлую и темную) с помощью дизайн-токенов. Эти токены представляют элементы дизайна, такие как цвета, шрифты и размеры, что позволяет согласованно настраивать переключение тем в вашем приложении.

#### Подключение стандартных тем
В этом разделе вы узнаете, как подключить светлую и темную темы, подключить стили Koobiq, включив их в свой основной файл стилей, и настроить переключение тем.

##### Описание процесса
Процесс настройки состоит из 4 основных этапов:
- 1 **Подключение основных стилей светлой и темной темы**, в рамках которой создается отдельная директория с файлами для каждого типа токенов соответственно - цвета тем и типографика.
- 2 **Подключение стилей Koobiq** - создаётся вспомогательный scss-файл для подключения в основной файл стилей. В данном вспомогательном файле:
   - 2.1 объявляются и применяются необходимые инструменты из пакета @koobiq/components - цвета, базовые визуальные элементы, темизация стандартных компонентов Koobiq
   - 2.2 Создаются миксины для подключения в основном файле - миксин базовой типографики и миксин для подключения цветов. Таким образом, структура вспомогательного файла стилей Koobiq выглядит так:
```
_theme.kbq.scss
  ├── объявление инструментов стилей из пакета @koobiq/components
  ├── применение инструментов из пакета @koobiq/components
  ├── миксин базовой типографики (@mixin app-typography)
  └── миксин для подключения цветов и темизации цветов (@mixin app-theme)
```
- 3 **Подключение вспомогательного файла стилей в основной файл стилей** - на данном этапе необходимо подключить файлы, где подключили темы на этапе 1 и стили Koobiq на этапе 2. Затем в рамках базового CSS-селектора `.kbq` задается подключение типографики и настраиваются стили для переключения тем.
- 4 **Настройка переключения тем** - данный этап подразумевает реализацию логики подстановки CSS-классов указанной темы. В рамках данного гайда используется сервис `KbqThemeService` из пакета `@koobiq/components/core` для управления переключением тем. CSS-селекторы для темной и светлой темы должны совпадать со значениями тем в инструменте для переключения тем. Каждый CSS-класс темы инкапсулирует настроенные цвета для всех стандартных компонентов Koobiq.

##### Подключение основных стилей светлой и темной темы
- 1 Создайте директорию стандартной темы: организуйте свои стили тем, добавив каталог для стандартных тем в каталоге стилей вашего проекта:
```
└─ koobiq
    └─ out-of-the-box-theme ·········· Директория для подключения стилей
      ├─ _theme.scss ················· Файл для подключенные миксинов темной и светлой темы
      └─ _typography.scss ············ Типографика для маркдауна и текста
    └─ _index.scss ··················· Файл, содержащий ссылки на sass-файлы из стандартной темы, нужен для удобного экспорта
```
- 2 Подключите необходимые стили в каждом из файлов:

| Название файла   | Подключаемые сущности                                |
|------------------|------------------------------------------------------|
| _theme.scss      | токены, миксины светлой и темной темы                |
| _typography.scss | токены, миксин типографики текста и миксин маркдауна |

- 3 Импортируйте стили тем в _index.scss: для дальнейшего использования и подключения в основной файл стилей, определите файлы стилей стандартной темы в [index файле.](https://sass-lang.com/documentation/at-rules/use/#index-files) 

```sass
@forward 'out-of-the-box-theme/theme' as out-of-the-box-theme-*;
```

##### Подключение стилей Koobiq
- 1 Создайте файл `_theme.kbq.scss` в папке `src/styles`
- 2 Добавьте основные миксины Koobiq, подключите базовую типографику и подготовьте миксины для подключения в основной файл стилей.

| Название миксина | Описание            | Аргументы миксина                            |
|------------------|---------------------|----------------------------------------------|
| app-typography   | базовая типографика | токены, конфиг типографики, конфиг маркдауна |
| app-theme        | цвета               | объект темы                                  |

##### Включение стилей Koobiq в основной файл стилей

Подключите раннее описанные стили в основной файл стилей. Основной файл стилей должен состоять из 2 секций: подключение зависимостей и css-классы для переключения тем.

- 1 Подключение зависимостей: добавьте файл _theme.kbq.scss со стилями Koobiq и основными миксинами и файл со стандартными темами
- 2 СSS-классы для переключения тем: структура CSS-классов выглядит следующим образом:
```
└─ .kbq ····························· рутовый CSS-class
    ├─ theme-kbq.app-typography ····· вызов миксина общей типографика для всех тем
    ├─ &.theme-light ················ CSS-класс, в нем вызывается миксин с токенами светлой темы
    └─ &.theme-dark ·················· CSS-класс, в нем вызывается миксин с токенами темной темы
```

##### Настройка переключения тем
Переключение темы представляет собой логику подстановки CSS-классов с указанной темой, которые инкапсулирует настроенные цвета для всех компонентов.

**Подготовка**

Добавьте необходимые классы тегу body в index.html:
- рутовый CSS-класс 
- CSS класс базовой темы, который вызовется, если сервис переключения тем не установит начальную тему

**Описание логики переключения тем с помощью ThemeService**

В рамках данного гайда используется сервис `ThemeService` из пакета `@koobiq/components` для управления переключением тем. Данный сервис реализует следующую логику:

- 1 При запуске приложения, можно передать сервису кастомные названия тем `ThemeService.setThemes()`: выводимое название и имя CSS-класса, а также выбран сейчас элемент или нет. Иначе, сервис подставит дефолтные значения для тем:

| Выводимое название темы | Имя CSS-класса  |
|-------------------------|-----------------|
| light                   | kbq-theme-light |
| dark                    | kbq-theme-dark  |

- 2 Установка начальной темы и изменение в зависимости от условия с помощью метода `ThemeService.setTheme(currentTheme)`. Здесь в зависимости от выбранной темы обновляется свойство `selected` и обновляется CSS-класс, присвоенный body.

##### Описание переключения в зависимости от операционной системы
Данный механизм возможно реализовать с помощью [window.matchMedia](https://developer.mozilla.org/en-US/docs/Web/API/Window/matchMedia);

Для реализации переключения темы в зависимости от операционной системы необходимы выполнить 3 условия:
- 1 Определить медиа-запрос для получения пользовательской темы: 
```javascript
colorAutomaticTheme = window.matchMedia('(prefers-color-scheme: light)');
```
- 2 Добавить объект темы в массив тем, который будет подключаться в сервисе темы при инициализации приложения. В данной теме свойство `className` будет устанавливаться по условию
```javascript
{
    name: 'Как в системе',
    className: this.colorAutomaticTheme.matches ? Themes.Default : Themes.Dark,
    selected: false
},
```
- 3 Подписаться на обновление темы пользователя и устанавливать активную тему при обновлении. Реализация Chrome & Firefox отличается реализации в Safari:
```javascript
try {
    // Chrome & Firefox
    this.colorAutomaticTheme.addEventListener('change', this.setAutoTheme);
} catch (err) {
    try {
        // Safari
        this.colorAutomaticTheme.addListener(this.setAutoTheme);
    } catch (errSafari) {
        // tslint:disable-next-line:no-console
        console.error(errSafari);
    }
}
```

Пример реализации переключения тем в документации Koobiq [тут.](https://github.com/koobiq/angular-components/blob/main/apps/docs/src/app/components/navbar/navbar.component.ts)

##### Пример на StackBlitz

Пример переключения стандартных тем [тут](https://stackblitz.com/edit/vaffk1?file=src%2Fstyles.scss)

#### Кастомизация Компонентов с помощью Дизайн Токенов
В этом разделе вы узнаете, как создать настраиваемый компонент с использованием дизайн токенов Koobiq. Имея цветовую палитру и предустановленные значения размеров и шрифтов, можно легко создавать и настраивать компоненты. Преимущество данного подхода заключается в том, что один используемый токен будет использовать разные значения для различных тем.

##### Подготовка
Для возможности кастомизации компонентов с помощью дизайн токенов необходимо настроить [подключение стандартных тем](#подключение-стандартных-тем) без логики переключения тем.

- 1 Создайте файл миксина в основном файле темы: подготовьте миксин кастомизируемых компонентов в файле `_theme.kbq.scss` для подключения в основной миксин `app-theme`. Данный миксин принимает информацию о токенах темы как параметр:
```sass
@mixin app-components-theme($theme) {
    // Здесь подключайте все стили тем для компонентов.
}
```
- 2 Подключите миксин кастомизируемых компонентов в основной миксин:
```sass
@mixin app-theme($theme) {
    // ... здесь будет ранее написанный код
    @include app-components-theme($theme);
}
```

##### Описание процесса
Процесс кастомизации компонента с помощью дизайн-токенов Koobiq состоит из 2 основных этапов:
- 1 **Создание и настройка компонента.** Здесь создаётся angular компонент по умолчанию и scss-файл темизации. Обычно, имя файла темизации задаётся в формате `_<component-name>-theme.scss`. В данном файле темизации создаётся 2 миксина - для подключения цветов из темы и для стилизации типографики. Основной файл стилей используется для кастомизации геометрии - ширина, высота, скругления и т.д.
- 2 **Импорт файла темизации кастомного компонента в основной файл стилей** - подключение миксина подключения цветов и миксина стилизации типографики в миксин темизации цветов и в миксин базовой типографики соответственно.

##### Создание компонента и добавление дизайн-токенов

- Создайте новый каталог компонентов со следующей структурой:
```
customized-component
  ├── _customized-component-theme.scss (Миксины стилей темы & типографики)
  ├── customized-component.component.scss (Определение геометрии)
  ├── customized-component.component.html
  ├── customized-component.component.spec.ts
  └── customized-component.component.ts
```
- 1. Создайте миксины дизайн-токенов: В _customized-component-theme.scss импортируйте два миксина (названия может быть любым):
-  для стилей цветов компонента, которые берутся из текущей темы
- для типографики компонента

```scss
@use '@koobiq/components/core/styles/typography';

@mixin kbq-customized-component($theme) {
  // ... your component's color styles using tokens from $theme
}

@mixin kbq-customized-component-typography($config) {
  // ... your component's typography styles using $config
}
```
- 2 Определите стили компонента: В `_customized-component-theme.scss` определите необходимые стили
- 3 Подключите описанные миксины в `_theme.kbq.scss`: миксин со стилями цветов в `app-components-theme`, а миксин с типографикой в  `app-typography`

##### Импорт стилей кастомного компонента в основной файл стилей

- Подключите описанные миксины в `_theme.kbq.scss`: миксин со стилями цветов в `app-components-theme`, а миксин с типографикой в  `app-typography`

##### Пример на StackBlitz
Пример кастомизации компонентов с помощью дизайн-токенов [тут](https://stackblitz.com/edit/vaffk1?file=src%2Fstyles.scss)

### Кастомизация: Уровень 2
В этом руководстве вы познакомитесь с процессом создания пользовательских дизайн-токенов и управления ими с помощью [Style-Dictionary](http://amzn.github.io/styledictionary/#/architecture). Пользовательские дизайн-токены позволяют вам переопределять свойства, используемые в дизайн-системе, делая их масштабируемым и персонализированными. Создание пользовательских дизайн-токенов аналогично созданию пользовательских тем.

#### Подготовка
Для создания кастомизированных токенов, необходимо добавить style-dictionary в зависимости:

npm:
```shell
npm install --save-dev style-dictionary
```

yarn:
```shell
yarn add --dev style-dictionary
```

#### Описание процесса
Процесс создания пользовательских тем состоит из 2 этапов:

- 1 **Создание кастомных токенов**
  - 1.1 **Создание директории.** Данный этап включает в себя создание директории рядом с директорией стандартной темы. Далее добавляем в эту директорию файлы с расширением .json5, чтобы задать значения, которые хотим настроить. Если для пользовательской темы необходимо переопределить некоторые значения стандартных тем, то наименования этих файлов должны совпадать с названиями из пакета `@koobiq/design-tokens`.
  - 1.2 **Создание скрипта генерации токенов.** Данный скрипт принимает на вход пути стандартных свойств дизайн-токенов, стандартных стилей компонентов, а также путь до файлов с переопределенными пользовательскими свойстами. Таким образом, скрипт расширяет и меняет значение базовых токенов, складывая их в директорию, указанную в `outputPath`.
- 2 **Применение кастомных токенов** - данный этап аналогичен [подключению стандартных тем](#подключение-стандартных-тем), только токены здесь берутся по локальным путям и меняется имя темы. Если для светлой/темной темы необходимо применение стандартного и пользовательского отображения, то можно настроить это путём уточнения CSS-класса.

#### Создание кастомных токенов
Чтобы создать пользовательские токены, вам необходимо подготовить директорию для новой темы. Вот как вы можете его настроить:

- 1 Создайте каталог темы: перейдите в каталог src/styles вашего проекта и создайте новый каталог с именем customized-theme. Структура должна выглядеть следующим образом:
```
└─ styles
    └─ koobiq ·························· Директория с темами
        ├─ customized-theme ············ Директория для кастомных токенов
        ├─ _index.scss
        └─ _theme.kbq.scss
```

- 2 Добавьте файлы переопределяемых свойств: Внутри директории customized-theme создайте директорию с именем properties.

В properties добавьте файлы с расширением .json5, чтобы задать значения, которые вы хотите настроить. Вот несколько примеров того, что могут содержать эти файлы:

| файл свойств        | описание                                                  |
|---------------------|-----------------------------------------------------------|
| colors.json5        | Именованные цвета для основных состояний и главных цветов |
| globals.json5       | Размеры, общие цвета                                      |
| md-typography.json5 | Типографика для маркдауна                                 |
| typography.json5    | Общая типографика                                         |
| palette.json5       | Палитра цветов со значениями                              |

Также, помимо основных свойств можно переопределить отдельные свойства стандартных компонентов Koobiq.

#### Создание скрипта генерации токенов
Чтобы автоматизировать процесс генерации токенов, добавьте скрипт в своем проекте. Этот скрипт будет отвечать за расширение и модификацию базовых токенов.

1. В вашем проекте создайте новый файл с именем build-tokens.js.

#### Применение кастомных токенов
Чтобы применить новую тему, вы можете подключить ее [таким же образом](#подключение-стандартных-тем), как и стандартные светлую/темную темы.

**Структура каталогов для нескольких тем**
Для управления несколькими наборами дизайн-токенов, организуйте свой каталог стилей следующим образом:
```
└─ styles
    └─ koobiq ························ Директория с наборами
        ├─ customized-theme ·········· Сгенерированный набор кастомных токенов с импортированными токенами
        ├─ out-of-the-box-theme ······ Набор с токенами по умолчанию из пакета Koobiq
        ├─ _index.scss ··············· Файл, содержащий ссылки на sass-файлы из стандартной темы, нужен для удобного экспорта
        └─ _theme.kbq.scss ··········· Файл стилей Koobiq
```

Если для светлой/темной темы необходимо применение стандартного и пользовательского отображения, то можно настроить это путём уточнения CSS-класса.

#### Пример на Stackblitz
Пример применения пользовательских тем можно найти [тут](https://stackblitz.com/edit/vaffk1?file=src%2Fstyles.scss)

### Использование CSS-переменных
В рамках дизайн-системы Koobiq помимо использования SCSS переменных, возможно использование [CSS переменных.](https://developer.mozilla.org/en-US/docs/Web/CSS/Using_CSS_custom_properties)

#### Описание процесса
Процесс применения CSS-переменных состоит из 4 этапов:

- 1 Переместите файл с CSS-переменных в вашу директорию со стилями: `css-tokens.css` из `@koobiq/design-tokens/web` например, в `src/styles`
- 2 Подключите к основной HTML-странице CSS-файл: `<link rel="stylesheet" href="styles/css-tokens.css">`
- 3 Для приложения с Angular CLI (опционально) добавьте объявление стилей: в раздел `architect.build.options.styles` путь до стилей - `src/styles/css-tokens.css`
- 4 Используйте CSS-переменные вместо объявленных ранее токенов.

#### Пример на Stackblitz
Пример применения CSS-переменных можно найти [тут](https://stackblitz.com/edit/vaffk1?file=src%2Fstyles.scss)
